<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=11"/>
<meta name="generator" content="Doxygen 1.9.2"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Saras: Saras - Finite difference solver</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<script type="text/x-mathjax-config">
MathJax.Hub.Config({
  extensions: ["tex2jax.js"],
  jax: ["input/TeX","output/HTML-CSS"],
});
</script>
<script type="text/javascript" async="async" src="http://cdn.mathjax.org/mathjax/latest/MathJax.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">Saras
   </div>
   <div id="projectbrief">Finite &nbsp; Difference &nbsp; Solver &nbsp; for &nbsp; Fluid &nbsp; Dynamics &nbsp; Simulations</div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.9.2 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
var searchBox = new SearchBox("searchBox", "search",'Search','.html');
/* @license-end */
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
/* @license-end */
</script>
<div id="main-nav"></div>
</div><!-- top -->
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div><div class="header">
  <div class="headertitle"><div class="title">Saras - Finite difference solver </div></div>
</div><!--header-->
<div class="contents">
<div class="textblock"><p ><a class="anchor" id="md_README"></a> <a href="https://opensource.org/licenses/BSD-3-Clause"><img src="https://img.shields.io/badge/License-BSD%203--Clause-blue.svg" alt="License" style="pointer-events: none;" class="inline"/></a> <a href="https://doi.org/10.21105/joss.02095"><img src="https://joss.theoj.org/papers/10.21105/joss.02095/status.svg" alt="DOI" style="pointer-events: none;" class="inline"/></a></p>
<p >SARAS is an MPI parallelized Navier-Stokes equation solver written in C++. It uses the finite-difference method for calculating spatial derivatives and parallelized geometric multi-grid method for solving the pressure Poisson equation.</p>
<p >All the relevant files of the solver are contained in the following directories:</p>
<ul>
<li><code>./src/</code> - contains the different solvers available in SARAS</li>
<li><code>./lib/</code> - contains all the libraries used by the solvers in <code>./src/</code> folder</li>
<li><code>./input/</code> - contains the parameters to be read by the solver</li>
<li><code>./output/</code> - the solution files are written into this folder, it also contains Python post-processing scripts</li>
</ul>
<h1><a class="anchor" id="autotoc_md14"></a>
Installing SARAS</h1>
<p ><code>SARAS</code> relies on a few libraries for its calculations. Therefore the first step towards building <code>SARAS</code> is to install the following dependencies:</p>
<ul>
<li><code>cmake</code> - Necessary to build the <code>saras</code> executable</li>
<li><code>mpich</code> - For parallel computation using MPI</li>
<li><code>hdf5</code> - The output files are written in HDF5 format</li>
<li><code>blitz</code> - All array manipulations are performed using the Blitz++ library</li>
<li><code>yaml-cpp</code> - The input parameters are stored in a YAML file which needs to be parsed using yaml-cpp library.</li>
</ul>
<p >Packages like <code>cmake</code>, <code>mpich</code>, and <code>hdf5</code> can be installed from the OS package manager. However, the latest versions of <code>blitz</code> and <code>yaml-cpp</code> packages can be downloaded from GitHub as described below.</p>
<p >If you do not have sudo privileges to install packages using the OS package manager, you can install them in your home folder instead. This also offers the potential advantage of not disturbing pre-existing packages already installed on the system. The steps listed below explain this method of installation.</p>
<p >That said, libraries like <code>cmake</code>, <code>MPICH</code> and <code>HDF5</code> are normally available on most computing systems. Please check if these packages are already installed, and if they are, you can skip their installation steps.</p>
<h2><a class="anchor" id="autotoc_md15"></a>
Download all the dependencies</h2>
<p >All the required packages can be downloaded and installed over a terminal. It is advisable to create a temporary directory where the packages can be downloaded and extracted. After navigating to the temporary directory, download the packages using <code>wget</code> command on Linux, or <code>curl</code> command on MacOS. <a href="https://cmake.org/download/">CMake</a>, <a href="https://www.mpich.org/downloads/">MPICH</a> and <a href="https://portal.hdfgroup.org/display/support/HDF5+1.8.21">HDF5</a> packages can be downloaded from their respective sites, and extracted by the <code>tar</code> command.</p>
<div class="fragment"><div class="line">wget https://cmake.org/files/v3.12/cmake-3.12.4.tar.gz</div>
<div class="line">wget http://www.mpich.org/static/downloads/3.4.2/mpich-3.4.2.tar.gz</div>
<div class="line">wget https://support.hdfgroup.org/ftp/HDF5/releases/hdf5-1.8/hdf5-1.8.21/src/hdf5-1.8.21.tar.gz</div>
<div class="line"> </div>
<div class="line">tar -xf cmake-3.12.4.tar.gz</div>
<div class="line">tar -xf mpich-3.4.2.tar.gz</div>
<div class="line">tar -xf hdf5-1.8.21.tar.gz</div>
</div><!-- fragment --><p >On Mac OS, please replace <code>wget</code> with <code>curl -O</code>. It is best to download the latest versions of <code>Blitz++</code> and <code>yaml-cpp</code> from their respective Git repositories.</p>
<div class="fragment"><div class="line">git clone https://github.com/jbeder/yaml-cpp.git</div>
<div class="line">git clone https://github.com/blitzpp/blitz.git</div>
</div><!-- fragment --><p >If you are installing on a remote machine which doesn't have direct internet access, the packages can be downloaded using the links listed above, and transferred over ssh or ftp.</p>
<blockquote class="doxtable">
<p >On MacOS, if the <code>tar</code> command fails with the error <code>Failed to set default locale</code>, the $LANG environment variable has to be set. For this you need to execute the command: <code>export LANG=en_US.UTF-8</code> </p>
</blockquote>
<p>Once all the downloaded packages have been extracted, create an install location in your home folder if it doesn't exist already. Usually, packages are installed in <code>$HOME/local/</code> directory. The next steps will assume that the folder <code>local/</code> exists in the user's home directory.</p>
<h2><a class="anchor" id="autotoc_md16"></a>
Install CMake</h2>
<p >After navigating to the folder created by extracting the <code>CMake</code> package, execute the following commands to configure the installation script and install the package:</p>
<div class="fragment"><div class="line">./configure --prefix=$HOME/local</div>
<div class="line">make -j4 install</div>
</div><!-- fragment --><p >Note that the option <code>-j4</code> given to <code>make</code> will use 4 cores of your system. If more cores are available, the process can be speeded-up by specifying a higher number.</p>
<h2><a class="anchor" id="autotoc_md17"></a>
Export path variables</h2>
<p >Once <code>CMake</code> has been installed in <code>$HOME/local</code> it should be made available for the next steps of installation. For this, the path variables have to be updated to let the system know that <code>cmake</code> is installed in <code>$HOME/local</code>. Accordingly, set the following environment variables:</p>
<div class="fragment"><div class="line">export PATH=$HOME/local/bin:$PATH</div>
<div class="line">export PKG_CONFIG_PATH=$HOME/local/lib/pkgconfig:$PKG_CONFIG_PATH</div>
<div class="line">export CPATH=$HOME/local/include/:$CPATH</div>
<div class="line">export LD_LIBRARY_PATH=$HOME/local/lib:$LD_LIBRARY_PATH</div>
<div class="line">export LIBRARY_PATH=$HOME/local/lib:$LIBRARY_PATH</div>
<div class="line">export MANPATH=$HOME/local/share/man/:$MANPATH</div>
</div><!-- fragment --><p >Please note that the environment variables set here exist only for the duration of the terminal session. If the session is terminated by closing the terminal or logging out, the variables will be reset. To permanently add the path variables, the above lines may be appended to the shell profile file (like <code>bashrc</code> or <code>bash_profile</code>).</p>
<h2><a class="anchor" id="autotoc_md18"></a>
Install yaml-cpp</h2>
<p >Installing the <code>yaml-cpp</code> package will require <code>cmake</code>. It is best to build the package within a temporary <code>build/</code> directory to avoid disturbing the source files. After navigating to the folder created by cloning the <code>yaml-cpp</code> repository, execute the following steps:</p>
<div class="fragment"><div class="line">mkdir build</div>
<div class="line">cd build/</div>
<div class="line">cmake -DCMAKE_INSTALL_PREFIX=$HOME/local ../</div>
<div class="line">make -j4 install</div>
</div><!-- fragment --><p >With <code>cmake</code>, the <code>-DCMAKE_INSTALL_PREFIX</code> argument performs the same function as <code>--prefix</code> for <code>make</code>, namely specifying the install directory.</p>
<blockquote class="doxtable">
<p ><code>SARAS</code> is now compatible with the latest versions of <code>yaml-cpp</code>. The older <code>yaml-cpp 0.3</code> uses <code>YAML::Parser::GetNextDocument</code> to parse the YAML file. However, this function is not secure and hence deprecated in later versions. If you have an older version of <code>yaml-cpp</code> installed on your system, you can still run <code>SARAS</code> with the older package. To enable this, the user has to pass the <code>-DYAML_LEGACY</code> flag to <code>CMake</code> when building <code>SARAS</code> later. </p>
</blockquote>
<h2><a class="anchor" id="autotoc_md19"></a>
Install MPICH</h2>
<p >Similar to the installation of <code>CMake</code>, <code>MPICH</code> also uses a configure script to install the package. After navigating to the folder created by extracting the <code>mpich</code> tarball, configure and install the package as done before:</p>
<div class="fragment"><div class="line">./configure --prefix=$HOME/local</div>
<div class="line">make -j4 install</div>
</div><!-- fragment --><blockquote class="doxtable">
<p >If the <code>configure</code> step throws the error <code>The Fortran compiler gfortran will not compile files that call the same routine with arguments of different types.</code>, please set the following flag, and rerun the configure script.</p>
<p ><code>export FFLAGS="-w -fallow-argument-mismatch -O2"</code> </p>
</blockquote>
<h2><a class="anchor" id="autotoc_md20"></a>
Install Blitz++</h2>
<p >Although older versions of <code>Blitz</code> used a configure script to build the package, the latest versions use <code>CMake</code> instead. Similar to the installation of <code>yaml-cpp</code>, you will have to build the package within a temporary <code>build/</code> directory. After navigating to the folder created by cloning the <code>blitz</code> repository, execute the following commands:</p>
<div class="fragment"><div class="line">mkdir build</div>
<div class="line">cd build/</div>
<div class="line">cmake -DCMAKE_INSTALL_PREFIX=$HOME/local ../</div>
<div class="line">make -j4 install</div>
</div><!-- fragment --><p >The latest version of <code>CMake</code> is required to build the <code>blitz</code> package. If the above steps fail due to <code>CMake</code> version mismatch, you will have to upgrade your <code>CMake</code>. If you installed <code>CMake</code> as done in the steps above, you will not face this issue, since the latest version of <code>CMake</code> was downloaded for the installation process described above.</p>
<blockquote class="doxtable">
<p >At the final step in <code>make install</code>, the Blitz++ installer may require <code>python2</code>. If you encounter an error due to Python version mismatch, please switch the environment to use <code>python2</code> temporarily for this step of the installation. </p>
</blockquote>
<h2><a class="anchor" id="autotoc_md21"></a>
Install HDF5 library</h2>
<p >The <code>HDF5</code> library requires <code>MPICH</code> so that it can perform parallel file I/O operations. Hence it must be installed only after installing <code>MPICH</code> (if <code>MPICH</code> was not already available on your system). A few additional build flags are also provided when building the <code>HDF5</code> library:</p>
<div class="fragment"><div class="line">CC=mpicc CXX=mpicxx ./configure --prefix=$HOME/local --enable-parallel --without-zlib</div>
<div class="line">make -j4 install</div>
</div><!-- fragment --><blockquote class="doxtable">
<p >Note that while building the <code>HDF5</code> library, it is being explicitly specified that the MPI compiler must be used. On some systems, it might be necessary to add an extra compiler flag before running <code>make</code> in order to install <code>HDF5</code> properly:</p>
<p ><code>export CFLAGS=-Wno-error=implicit-function-declaration</code> </p>
</blockquote>
<h2><a class="anchor" id="autotoc_md22"></a>
Clone and install SARAS</h2>
<p >With luck, the above steps will have installed all the dependencies required by <code>SARAS</code>. Now the <code>saras</code> repository can be cloned into your machine:</p>
<div class="fragment"><div class="line">git clone https://github.com/roshansamuel/saras.git</div>
</div><!-- fragment --><p >After navigating to the folder created by cloning the repository, you can follow the same steps for building the package as done when installing <code>Blitz</code>, <code>yaml-cpp</code>, etc.</p>
<div class="fragment"><div class="line">mkdir build</div>
<div class="line">cd build/</div>
<div class="line">CC=mpicc CXX=mpicxx cmake ../</div>
<div class="line">make -j4</div>
</div><!-- fragment --><p ><code>CMake</code> will build the <code>saras</code> executable in the root folder of the solver. The following flags can be passed to <code>CMake</code> to enable/disable different features of <code>SARAS</code>:</p>
<ul>
<li><code>-DPLANAR=ON</code> - This compiles <code>SARAS</code> for 2D simulations. By default, <code>SARAS</code> is compiled for 3D runs</li>
<li><code>-DREAL_SINGLE=ON</code> - <code>SARAS</code> can compute in single-precision. By default, <code>SARAS</code> uses double-precision</li>
<li><code>-DTIME_RUN=ON</code> - This flag suppresses file-writing and I/O when compiling the solver for scaling studies</li>
<li><code>-DYAML_LEGACY=ON</code> - As described previously, this flag allows <code>SARAS</code> to use older versions of <code>yaml-cpp</code></li>
</ul>
<p >For example, to build <code>SARAS</code> for a 2D simulation using single-precision calculations, the solver will be configured as:</p>
<div class="fragment"><div class="line">CC=mpicc CXX=mpicxx cmake -DPLANAR=ON -DREAL_SINGLE=ON ../</div>
</div><!-- fragment --><p >Note that the MPI compilers have to be specified to <code>CMake</code> for the MPI headers to be found when building the executable.</p>
<h1><a class="anchor" id="autotoc_md23"></a>
Running SARAS</h1>
<p ><code>SARAS</code> can be executed by issuing the <code>mpirun</code> command at the root folder of the solver.</p>
<p ><code>mpirun -np &lt;number_of_processors&gt; ./saras</code></p>
<p >It is essential to set the parameters appropriately with the <code>parameters.yaml</code> file in the <code>input/</code> folder of the solver. The number of processors specified to the <code>mpirun</code> command should be equal to the product of <code>X Number of Procs</code> and <code>Y Number of Procs</code> options within the <code>Parallel</code> sub-section of <code>parameters.yaml</code>. Please check the <code>parameters.yaml</code> file for the full list of options specifiable to the solver, and their explanations (in comments).</p>
<p >For more information please refer to the <code>SARAS</code> <a href="https://roshansamuel.github.io/saras/">documentation</a>.</p>
<h1><a class="anchor" id="autotoc_md24"></a>
Testing SARAS</h1>
<p ><code>SARAS</code> offers an automated testing process to validate the solver after installation. The relevant test scripts can be found in the <code>tests/</code> folder of the solver. Executing the Bash shell script <code>testLDC.sh</code>, will compile <code>SARAS</code>, and run it with a pre-defined set of parameters. We use the benchmark results on 2D lid-driven cavity (LDC) performed by Ghia et al (1982) to validate <code>SARAS</code>. The test can be executed by running the following command within the <code>tests/</code> folder.</p>
<p ><code>bash testLDC.sh</code></p>
<p >The test uses 4 cores and takes about 12 minutes to complete on an Intel workstation. At the end of the test, the Python script <code><a class="el" href="checkLDC_8py.html" title="Saras.">checkLDC.py</a></code>, found in <code>tests/ldcTest/</code> reads the output, and plots the velocity profiles along with the data from Ghia et al's result.</p>
<p >The following Python modules are necessary for the Python test script to execute successfully</p>
<ul>
<li>numpy</li>
<li>scipy</li>
<li>matplotlib</li>
<li>h5py</li>
<li>yaml</li>
</ul>
<p >At the end of the test, a plot of the x and y velocity profiles is shown to the user and saved as <code>ldc_validation.png</code> in the folder <code>tests/ldcTest/</code>. Additionally, the convergence of the multi-grid Poisson solver of <code>SARAS</code> can also be tested. This test is also available in the <code>tests/</code> folder.</p>
<h1><a class="anchor" id="autotoc_md25"></a>
Setting up a new case in SARAS</h1>
<p >After generating the <code>saras</code> executable file as described in the section on <a href="#clone-and-install-saras">Installing SARAS</a>, The executable has to be placed in a folder with two sub-folders: <code>input/</code> and <code>output/</code>. <code>SARAS</code> will read parameters from the <code>input/</code> folder, and write solution data into the <code>output/</code> folder.</p>
<h2><a class="anchor" id="autotoc_md26"></a>
Set the parameters file</h2>
<p >The parameters of a case to be simulated with <code>SARAS</code> are specified in a YAML file named <code>parameters.yaml</code>. The user must set these parameters appropriately before executing <code>saras</code>.</p>
<p >A sample <code>parameters.yaml</code> file is provided with the solver in the <code>./input/</code> folder. The parameters are grouped under 5 sections, viz., <code>Program</code>, <code>Mesh</code>, <code>Parallel</code>, <code>Solver</code> and <code>Multigrid</code>.</p>
<ul>
<li>The main parameters that set the boundary conditions, initial conditions, forcing/source terms, etc. are found under the <code>Program</code> section.</li>
<li>Grid parameters like number of points, stretching parameter for non-uniform grids, etc. are found under the <code>Mesh</code> section.</li>
<li><code>Parallel</code> section lets the user define how many MPI sub-domains to decompose the computational domain.</li>
<li>Non-dimensional time-step, file write intervals, final non-dimensional time and so on are set in the <code>Solver</code> section.</li>
<li>Finally, <code>Multigrid</code> section lets the user tweak the parameters of the Geometric Multi-grid solver used to solve the pressure Poisson equation.</li>
</ul>
<p >Each parameter has documentation written into the <code>parameters.yaml</code> file itself.</p>
<blockquote class="doxtable">
<p >Additionally, the user can add custom boundary conditions to the <code>boundary</code> library. The source files of the <code>boundary</code> library can be found in <code>./lib/boundary</code> folder of the solver. Similarly, the user can add custom initial conditions to the <code>initial</code> library in the <code>./lib/initial/</code> folder, and custom forcing/source terms to the <code>force</code> library in <code>./lib/force/</code>. All the source files in these libraries have extensive Doxygen documentation, and are written to be as self-explanatory as possible. </p>
</blockquote>
<h2><a class="anchor" id="autotoc_md27"></a>
Running and processing data</h2>
<p >The solver will write the solution data files into <code>./output/</code> folder. Based on the values in <code>parameters.yaml</code>, the solver may write solution data, time series, probe measurements, etc. in this folder. The solver will also periodically dump the entire field data into a file named <code>restartFile.h5</code>. This file will be read by the solver to resume computations, should it stop before completing the simulation.</p>
<p >The solution data is written in HDF5 format, while time-series and probe data are written in ASCII format. Many open source visualization software are capable of reading HDF5 data format. Moreover, Python can also read HDF5 files using the <code>h5py</code> module.</p>
<h1><a class="anchor" id="autotoc_md28"></a>
License</h1>
<p ><code>SARAS</code> is an open-source package made available under the New BSD License.</p>
<h1><a class="anchor" id="autotoc_md29"></a>
Contributions and bug reports</h1>
<p >Contributions to this project are very welcome. If you wish to contribute, please create a branch with a <a href="https://github.com/roshansamuel/saras/pulls">pull request</a> and the proposed changes can be discussed there.</p>
<p >If you find a bug, please open a new <a href="https://github.com/roshansamuel/saras/issues/new">issue</a> on the GitHub repository to report the bug. Please provide sufficient information for the bug to be reproduced.</p>
<h1><a class="anchor" id="autotoc_md30"></a>
References</h1>
<p >Various articles and pages used to make programming decisions during development of the solver are listed here:</p>
<h2><a class="anchor" id="autotoc_md31"></a>
General articles</h2>
<ol type="1">
<li><a href="https://stackoverflow.com/questions/4816698/avoiding-circular-dependencies-of-header-files">https://stackoverflow.com/questions/4816698/avoiding-circular-dependencies-of-header-files</a></li>
<li><a href="https://stackoverflow.com/questions/8111677/what-is-argument-dependent-lookup-aka-adl-or-koenig-lookup">https://stackoverflow.com/questions/8111677/what-is-argument-dependent-lookup-aka-adl-or-koenig-lookup</a></li>
<li><a href="https://www.codesynthesis.com/~boris/blog/2012/04/04/when-provide-empty-destructor/">https://www.codesynthesis.com/~boris/blog/2012/04/04/when-provide-empty-destructor/</a></li>
</ol>
<h2><a class="anchor" id="autotoc_md32"></a>
Articles on multi-grid methods</h2>
<ol type="1">
<li><a href="http://math.mit.edu/classes/18.086/2006/am63.pdf">http://math.mit.edu/classes/18.086/2006/am63.pdf</a></li>
<li><a href="http://www.mgnet.org/mgnet-tuts.html">http://www.mgnet.org/mgnet-tuts.html</a></li>
</ol>
<h2><a class="anchor" id="autotoc_md33"></a>
Journal references</h2>
<ol type="1">
<li>Ghia, U., Ghia, K. N., &amp; Shin, C. T. (1982). High-Re solutions for incompressible flow using the Navier-Stokes equations and a multigrid method. J. Comput. Phys., 48(3), 387-411. </li>
</ol>
</div></div><!-- PageDoc -->
</div><!-- contents -->
<!-- start footer part -->
<hr class="footer"/><address class="footer"><small>
Generated on Wed Sep 1 2021 14:29:00 for Saras by&#160;<a href="https://www.doxygen.org/index.html"><img class="footer" src="doxygen.svg" width="104" height="31" alt="doxygen"/></a> 1.9.2
</small></address>
</body>
</html>
